name: Build APK and Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:
  release:
    types: [created]

jobs:
  build-apk:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm run install-all

      - name: Build React app
        run: |
          cd client
          CI=false npm run build
          cd ..
          echo "‚úÖ React app built successfully"

      - name: Setup Java JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Bubblewrap CLI
        run: npm install -g @bubblewrap/cli

      - name: Prepare app URL
        id: app_url
        run: |
          APP_URL="${{ secrets.APP_URL }}"
          if [ -z "$APP_URL" ]; then
            # Try to construct from repository or use default
            APP_URL="https://adlc-emergency-app.onrender.com"
          fi
          echo "Using app URL: $APP_URL"
          echo "app_url=$APP_URL" >> $GITHUB_OUTPUT

      - name: Initialize TWA project
        working-directory: client
        continue-on-error: true
        run: |
          APP_URL="${{ steps.app_url.outputs.app_url }}"
          echo "Initializing TWA with URL: $APP_URL"
          
          # Create TWA directory if it doesn't exist
          mkdir -p twa
          
          # Initialize using bubblewrap (non-interactive)
          echo "n" | bubblewrap init \
            --manifest="$APP_URL/manifest.json" \
            --directory=twa \
            --package-id=com.adlc.emergency || {
            echo "Bubblewrap init failed, creating manual config..."
            
            # Create manual TWA manifest
            cat > twa/twa-manifest.json << EOF
          {
            "packageId": "com.adlc.emergency",
            "host": "$(echo $APP_URL | sed 's|https\?://||' | sed 's|/.*||')",
            "name": "ADLC Emergency Services",
            "launcherName": "ADLC Emergency",
            "display": "standalone",
            "themeColor": "#1f2937",
            "navigationColor": "#1f2937",
            "backgroundColor": "#111827",
            "enableNotifications": true,
            "startUrl": "/",
            "iconUrl": "$APP_URL/logo.png",
            "maskableIconUrl": "$APP_URL/logo.png",
            "monochromeIconUrl": "$APP_URL/logo.png",
            "shortcuts": [],
            "generatorApp": "bubblewrap-cli",
            "webManifestUrl": "$APP_URL/manifest.json",
            "appVersionName": "${{ github.ref_name || '1.0.0' }}",
            "appVersionCode": ${{ github.run_number }},
            "minSdkVersion": 19,
            "orientation": "default",
            "fingerprints": [],
            "additionalTrustedOrigins": [],
            "retainedBundles": [],
            "appVersion": "1.0.0"
          }
          EOF
          }

      - name: Build APK with Bubblewrap
        working-directory: client
        continue-on-error: true
        run: |
          if [ -d "twa" ]; then
            cd twa
            echo "Building APK in twa directory..."
            bubblewrap build --skipSigning || bubblewrap build
            cd ..
          else
            echo "TWA directory not found, trying direct build..."
            bubblewrap build --skipSigning --skipPwaValidation || true
          fi

      - name: Find APK files
        id: find_apk
        working-directory: client
        run: |
          echo "Searching for APK files..."
          find . -name "*.apk" -type f 2>/dev/null | head -20
          
          APK_PATH=$(find . -name "*.apk" -type f 2>/dev/null | head -n 1)
          if [ -n "$APK_PATH" ]; then
            echo "‚úÖ APK found at: $APK_PATH"
            echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT
            echo "apk_found=true" >> $GITHUB_OUTPUT
            ls -lh "$APK_PATH"
          else
            echo "‚ùå APK not found"
            echo "apk_found=false" >> $GITHUB_OUTPUT
            echo "Listing build directories:"
            ls -la twa/ 2>/dev/null || echo "No twa directory"
            find . -type d -name "app" -o -name "build" 2>/dev/null | head -10
          fi

      - name: Upload APK artifact
        if: steps.find_apk.outputs.apk_found == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: adlc-emergency-apk
          path: ${{ steps.find_apk.outputs.apk_path }}
          retention-days: 90

      - name: Build status
        if: steps.find_apk.outputs.apk_found != 'true'
        run: |
          echo "‚ö†Ô∏è APK build failed or APK not found"
          echo "This might be because:"
          echo "1. The app needs to be deployed first (so manifest.json is accessible)"
          echo "2. Bubblewrap needs the APP_URL secret set to your deployed URL"
          echo "3. Check the build logs above for errors"
          exit 1

      - name: Create GitHub Release
        if: github.event_name == 'release' && steps.find_apk.outputs.apk_found == 'true'
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ steps.find_apk.outputs.apk_path }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Render deployment happens automatically on push via Render's webhook
  # This job is just a placeholder to show the workflow completes
  deploy-notification:
    runs-on: ubuntu-latest
    needs: build-apk
    if: always()
    steps:
      - name: Deployment Status
        run: |
          if [ "${{ needs.build-apk.result }}" == "success" ]; then
            echo "‚úÖ APK build successful! Render deployment will happen automatically on push."
            echo "üì± APK is available in the workflow artifacts."
          else
            echo "‚ö†Ô∏è APK build had issues. Render deployment will still happen automatically."
            echo "Check the build-apk job logs for details."
          fi
