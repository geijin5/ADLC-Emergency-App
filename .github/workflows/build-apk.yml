name: Build APK

on:
  push:
    branches:
      - main
  workflow_dispatch:
  release:
    types: [created]

jobs:
  build-apk:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm run install-all

      - name: Build React app
        run: |
          cd client
          CI=false npm run build
          cd ..
          echo "‚úÖ React app built successfully"
          ls -la client/build/ | head -10

      - name: Setup Java JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Capacitor CLI
        run: npm install -g @capacitor/cli

      - name: Initialize Capacitor (if needed)
        working-directory: client
        continue-on-error: true
        run: |
          if [ ! -f "capacitor.config.json" ] && [ ! -f "capacitor.config.ts" ]; then
            npx cap init "ADLC Emergency Services" "com.adlc.emergency" --web-dir=build || true
          fi

      - name: Add Android platform
        working-directory: client
        continue-on-error: true
        run: |
          if [ ! -d "android" ]; then
            npx cap add android || true
          fi

      - name: Sync web assets to Android
        working-directory: client
        continue-on-error: true
        run: |
          if [ -d "android" ]; then
            npx cap sync android || true
          fi

      - name: Update Android build configuration
        working-directory: client
        run: |
          if [ -f "android/app/build.gradle" ]; then
            # Update version code and name
            sed -i 's/versionCode [0-9]*/versionCode '${{ github.run_number }}'/' android/app/build.gradle || true
            sed -i 's/versionName ".*"/versionName "'${{ github.ref_name || '1.0.0' }}'"/' android/app/build.gradle || true
            echo "‚úÖ Android build config updated"
          else
            echo "‚ö†Ô∏è Android directory not found, skipping config update"
          fi

      - name: Build APK with Gradle
        working-directory: client/android
        continue-on-error: true
        run: |
          if [ -f "gradlew" ]; then
            chmod +x gradlew
            ./gradlew assembleRelease || ./gradlew assembleDebug
            echo "‚úÖ Gradle build completed"
          else
            echo "‚ùå gradlew not found"
            exit 1
          fi

      - name: Find APK file
        id: find_apk
        working-directory: client
        run: |
          echo "Searching for APK files..."
          find . -name "*.apk" -type f 2>/dev/null | while read file; do
            echo "Found: $file ($(du -h "$file" | cut -f1))"
          done
          
          APK_PATH=$(find . -path "*/release/*.apk" -o -path "*/debug/*.apk" -type f 2>/dev/null | head -n 1)
          
          if [ -z "$APK_PATH" ]; then
            APK_PATH=$(find . -name "*.apk" -type f 2>/dev/null | head -n 1)
          fi
          
          if [ -n "$APK_PATH" ]; then
            echo "‚úÖ APK found at: $APK_PATH"
            echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT
            echo "apk_found=true" >> $GITHUB_OUTPUT
            ls -lh "$APK_PATH"
          else
            echo "‚ùå APK not found after build"
            echo "apk_found=false" >> $GITHUB_OUTPUT
            echo "Listing android directory structure:"
            find android -type d -name "app" -o -name "build" 2>/dev/null | head -20
            ls -la android/app/ 2>/dev/null || true
          fi

      - name: Upload APK artifact
        if: steps.find_apk.outputs.apk_found == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: adlc-emergency-apk
          path: ${{ steps.find_apk.outputs.apk_path }}
          retention-days: 90

      - name: Build failure notification
        if: steps.find_apk.outputs.apk_found != 'true'
        run: |
          echo "‚ö†Ô∏è APK build completed but APK file not found"
          echo ""
          echo "This could happen if:"
          echo "1. Capacitor Android platform wasn't properly initialized"
          echo "2. Gradle build had errors (check logs above)"
          echo "3. APK was built but in an unexpected location"
          echo ""
          echo "To fix this:"
          echo "- Check the build logs above for Gradle errors"
          echo "- Ensure the React build completed successfully"
          echo "- Try running 'npx cap add android' locally first"
          echo ""
          echo "Note: This failure does NOT affect Render deployment."
          echo "The web app will still deploy successfully to Render."

      - name: Create GitHub Release
        if: github.event_name == 'release' && steps.find_apk.outputs.apk_found == 'true'
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ steps.find_apk.outputs.apk_path }}
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Render deployment notification (Render deploys automatically via webhook)
  deploy-info:
    runs-on: ubuntu-latest
    needs: build-apk
    if: always()
    steps:
      - name: Deployment Status
        run: |
          if [ "${{ needs.build-apk.result }}" == "success" ]; then
            echo "‚úÖ APK build successful!"
            echo "üì± APK is available in the workflow artifacts."
          else
            echo "‚ö†Ô∏è APK build had issues (see build-apk job)."
          fi
          echo ""
          echo "üåê Render deployment happens automatically on push via webhook."
          echo "   Check your Render dashboard for deployment status."
