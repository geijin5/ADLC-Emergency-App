name: Build APK

on:
  push:
    branches:
      - main
  workflow_dispatch:
  release:
    types: [created]

jobs:
  build-apk:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm run install-all

      - name: Build React app
        run: |
          cd client
          CI=false npm run build
          cd ..
          echo "‚úÖ React app built successfully"
          if [ -d "client/build" ]; then
            echo "Build directory exists with $(ls -1 client/build | wc -l) files"
          else
            echo "‚ùå Build directory not found!"
            exit 1
          fi

      - name: Setup Java JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Capacitor CLI and core
        run: |
          npm install -g @capacitor/cli @capacitor/core
          cd client
          npm install @capacitor/cli @capacitor/core @capacitor/android --save-dev || npm install @capacitor/cli @capacitor/core @capacitor/android
          cd ..

      - name: Initialize Capacitor
        working-directory: client
        run: |
          echo "Checking for existing Capacitor config..."
          if [ -f "capacitor.config.json" ] || [ -f "capacitor.config.ts" ]; then
            echo "‚úÖ Capacitor config already exists"
            cat capacitor.config.json 2>/dev/null || cat capacitor.config.ts
          else
            echo "Initializing Capacitor..."
            # Create config manually to avoid interactive prompts
            cat > capacitor.config.json << EOF
          {
            "appId": "com.adlc.emergency",
            "appName": "ADLC Emergency Services",
            "webDir": "build",
            "bundledWebRuntime": false
          }
          EOF
            echo "‚úÖ Capacitor config created"
            cat capacitor.config.json
          fi

      - name: Add Android platform
        working-directory: client
        run: |
          if [ -d "android" ]; then
            echo "‚úÖ Android platform already exists"
            ls -la android/ | head -5
          else
            echo "Adding Android platform..."
            npx cap add android
            if [ ! -d "android" ]; then
              echo "‚ùå Failed to create android directory"
              exit 1
            fi
            echo "‚úÖ Android platform added"
          fi

      - name: Sync web assets to Android
        working-directory: client
        run: |
          echo "Syncing web assets..."
          npx cap sync android
          echo "‚úÖ Sync completed"
          
          # Verify sync worked
          if [ -d "android/app/src/main/assets/public" ]; then
            echo "‚úÖ Assets synced successfully"
            ls -la android/app/src/main/assets/public/ | head -5
          else
            echo "‚ö†Ô∏è Assets directory not found, but continuing..."
          fi

      - name: Update Android build configuration
        working-directory: client
        run: |
          if [ -f "android/app/build.gradle" ]; then
            echo "Updating build.gradle..."
            # Update version code
            sed -i 's/versionCode [0-9]*/versionCode '${{ github.run_number }}'/' android/app/build.gradle || \
            sed -i '/defaultConfig {/a\        versionCode '${{ github.run_number }}'' android/app/build.gradle || true
            
            # Update version name
            sed -i 's/versionName ".*"/versionName "'${{ github.ref_name || '1.0.0' }}'"/' android/app/build.gradle || \
            sed -i '/versionCode/a\        versionName "'${{ github.ref_name || '1.0.0' }}'"' android/app/build.gradle || true
            
            echo "‚úÖ Build config updated"
          else
            echo "‚ö†Ô∏è build.gradle not found"
            exit 1
          fi

      - name: Fix Kotlin dependency conflicts
        working-directory: client
        run: |
          if [ -f "android/app/build.gradle" ]; then
            echo "Fixing Kotlin dependency conflicts..."
            if ! grep -q "configurations.all" android/app/build.gradle; then
              echo 'import sys' > /tmp/fix_kotlin.py
              echo "with open('android/app/build.gradle', 'r') as f:" >> /tmp/fix_kotlin.py
              echo '    lines = f.readlines()' >> /tmp/fix_kotlin.py
              echo "deps_idx = next((i for i, line in enumerate(lines) if line.strip().startswith('dependencies {')), -1)" >> /tmp/fix_kotlin.py
              echo "config = '\nconfigurations.all {\n    exclude group: \\'org.jetbrains.kotlin\\', module: \\'kotlin-stdlib-jdk7\\'\n    exclude group: \\'org.jetbrains.kotlin\\', module: \\'kotlin-stdlib-jdk8\\'\n}\n\n'" >> /tmp/fix_kotlin.py
              echo 'if deps_idx >= 0:' >> /tmp/fix_kotlin.py
              echo '    lines.insert(deps_idx, config)' >> /tmp/fix_kotlin.py
              echo 'else:' >> /tmp/fix_kotlin.py
              echo '    lines.append(config)' >> /tmp/fix_kotlin.py
              echo "with open('android/app/build.gradle', 'w') as f:" >> /tmp/fix_kotlin.py
              echo '    f.writelines(lines)' >> /tmp/fix_kotlin.py
              echo "print('Added Kotlin dependency exclusions')" >> /tmp/fix_kotlin.py
              python3 /tmp/fix_kotlin.py
              rm -f /tmp/fix_kotlin.py
              echo "Verifying fix was applied..."
              if grep -q "configurations.all" android/app/build.gradle; then
                echo "‚úÖ Kotlin dependency exclusions verified in build.gradle"
                grep -A 3 "configurations.all" android/app/build.gradle || true
              else
                echo "‚ùå Failed to add Kotlin dependency exclusions"
                exit 1
              fi
            else
              echo "Kotlin dependency exclusions already exist"
              grep -A 3 "configurations.all" android/app/build.gradle || true
            fi
            echo "‚úÖ Kotlin dependency conflicts fixed"
          else
            echo "‚ö†Ô∏è build.gradle not found"
            exit 1
          fi

      - name: Verify Android setup
        working-directory: client
        run: |
          echo "Verifying Android setup..."
          if [ ! -d "android" ]; then
            echo "‚ùå android directory not found"
            exit 1
          fi
          
          if [ ! -f "android/gradlew" ]; then
            echo "‚ùå gradlew not found"
            ls -la android/
            exit 1
          fi
          
          echo "‚úÖ Android setup verified"
          ls -la android/ | head -10

      - name: Build APK with Gradle
        working-directory: client/android
        run: |
          echo "Building APK..."
          chmod +x gradlew
          
          # Accept licenses
          yes | sdkmanager --licenses || true
          
          # Build debug APK (automatically signed, works for testing)
          # Debug APKs are properly signed and can be installed without issues
          echo "Building debug APK (automatically signed)..."
          if ./gradlew assembleDebug; then
            echo "‚úÖ Debug build successful"
            BUILD_TYPE="debug"
          else
            echo "‚ùå Debug build failed"
            exit 1
          fi
          
          echo "‚úÖ Gradle build completed (type: $BUILD_TYPE)"
          echo "Listing APK output directory:"
          ls -la app/build/outputs/apk/$BUILD_TYPE/ || echo "APK directory not found"
          echo "APK files found:"
          find app/build/outputs/apk/$BUILD_TYPE -name "*.apk" -type f 2>/dev/null || echo "No APK files found"

      - name: Find APK file
        id: find_apk
        working-directory: client
        run: |
          echo "Searching for APK files..."
          echo "Current directory: $(pwd)"
          echo "Listing android directory structure:"
          ls -la android/app/build/outputs/apk/ 2>/dev/null || echo "APK outputs directory doesn't exist"
          
          # Search in standard locations
          APK_PATH=""
          
          if [ -d "android/app/build/outputs/apk/release" ]; then
            echo "Release directory exists, listing contents:"
            ls -la android/app/build/outputs/apk/release/ || true
            APK_PATH=$(find android/app/build/outputs/apk/release -name "*.apk" -type f 2>/dev/null | head -n 1)
            if [ -n "$APK_PATH" ]; then
              echo "Found APK in release: $APK_PATH"
            fi
          fi
          
          if [ -z "$APK_PATH" ] && [ -d "android/app/build/outputs/apk/debug" ]; then
            echo "Debug directory exists, listing contents:"
            ls -la android/app/build/outputs/apk/debug/ || true
            APK_PATH=$(find android/app/build/outputs/apk/debug -name "*.apk" -type f 2>/dev/null | head -n 1)
            if [ -n "$APK_PATH" ]; then
              echo "Found APK in debug: $APK_PATH"
            fi
          fi
          
          if [ -z "$APK_PATH" ]; then
            echo "Searching entire android directory for APK files..."
            find android -name "*.apk" -type f 2>/dev/null | head -5 || echo "No APK files found"
            APK_PATH=$(find android -name "*.apk" -type f 2>/dev/null | head -n 1)
          fi
          
          if [ -n "$APK_PATH" ] && [ -f "$APK_PATH" ]; then
            echo "‚úÖ APK found at: $APK_PATH"
            echo "File exists: $(test -f "$APK_PATH" && echo 'yes' || echo 'no')"
            echo "Size: $(du -h "$APK_PATH" | cut -f1)"
            # Ensure path is relative to workspace root (client directory is working directory)
            # APK_PATH should already be relative to client directory
            echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT
            echo "apk_found=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå APK not found or file doesn't exist"
            echo "APK_PATH was: $APK_PATH"
            echo "Listing build outputs directory structure:"
            find android/app/build/outputs -type d 2>/dev/null | head -20 || echo "No outputs directory"
            echo "Listing all files in outputs:"
            find android/app/build/outputs -type f 2>/dev/null | head -20 || echo "No output files"
            echo "apk_found=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload APK artifact
        if: steps.find_apk.outputs.apk_found == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: adlc-emergency-apk
          path: client/${{ steps.find_apk.outputs.apk_path }}
          retention-days: 90

      - name: Build failure notification
        if: steps.find_apk.outputs.apk_found != 'true'
        run: |
          echo "::warning::APK build completed but APK file not found"
          echo ""
          echo "Debugging information:"
          echo "- Check if Gradle build completed successfully above"
          echo "- Verify Android SDK is properly set up"
          echo "- Check for Gradle errors in the build output"
          echo ""
          echo "This failure does NOT affect Render deployment."
          echo "The web app will still deploy successfully to Render."

  # Render deployment notification (Render deploys automatically via webhook)
  deploy-info:
    runs-on: ubuntu-latest
    needs: build-apk
    if: always()
    steps:
      - name: Deployment Status
        run: |
          if [ "${{ needs.build-apk.result }}" == "success" ] && [ "${{ needs.build-apk.outputs.apk_found }}" == "true" ]; then
            echo "‚úÖ APK build successful!"
            echo "üì± APK is available in the workflow artifacts."
          else
            echo "‚ö†Ô∏è APK build had issues (see build-apk job)."
          fi
          echo ""
          echo "üåê Render deployment happens automatically on push via webhook."
          echo "   Check your Render dashboard for deployment status."
