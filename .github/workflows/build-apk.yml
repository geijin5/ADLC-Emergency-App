name: Build APK

on:
  push:
    branches:
      - main
  workflow_dispatch:
  release:
    types: [created]

jobs:
  build-apk:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm run install-all

      - name: Build React app
        run: |
          cd client
          CI=false npm run build
          cd ..
          echo "‚úÖ React app built successfully"
          if [ -d "client/build" ]; then
            echo "Build directory exists with $(ls -1 client/build | wc -l) files"
          else
            echo "‚ùå Build directory not found!"
            exit 1
          fi

      - name: Setup Java JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Capacitor CLI and core
        run: |
          npm install -g @capacitor/cli @capacitor/core
          cd client
          npm install @capacitor/cli @capacitor/core @capacitor/android --save-dev || npm install @capacitor/cli @capacitor/core @capacitor/android
          cd ..

      - name: Initialize Capacitor
        working-directory: client
        run: |
          echo "Checking for existing Capacitor config..."
          if [ -f "capacitor.config.json" ] || [ -f "capacitor.config.ts" ]; then
            echo "‚úÖ Capacitor config already exists"
            cat capacitor.config.json 2>/dev/null || cat capacitor.config.ts
          else
            echo "Initializing Capacitor..."
            # Create config manually to avoid interactive prompts
            cat > capacitor.config.json << EOF
          {
            "appId": "com.adlc.emergency",
            "appName": "ADLC Emergency Services",
            "webDir": "build",
            "bundledWebRuntime": false
          }
          EOF
            echo "‚úÖ Capacitor config created"
            cat capacitor.config.json
          fi

      - name: Add Android platform
        working-directory: client
        run: |
          if [ -d "android" ]; then
            echo "‚úÖ Android platform already exists"
            ls -la android/ | head -5
          else
            echo "Adding Android platform..."
            npx cap add android
            if [ ! -d "android" ]; then
              echo "‚ùå Failed to create android directory"
              exit 1
            fi
            echo "‚úÖ Android platform added"
          fi

      - name: Sync web assets to Android
        working-directory: client
        run: |
          echo "Syncing web assets..."
          npx cap sync android
          echo "‚úÖ Sync completed"
          
          # Verify sync worked
          if [ -d "android/app/src/main/assets/public" ]; then
            echo "‚úÖ Assets synced successfully"
            ls -la android/app/src/main/assets/public/ | head -5
          else
            echo "‚ö†Ô∏è Assets directory not found, but continuing..."
          fi

      - name: Update Android build configuration
        working-directory: client
        run: |
          if [ -f "android/app/build.gradle" ]; then
            echo "Updating build.gradle..."
            # Update version code
            sed -i 's/versionCode [0-9]*/versionCode '${{ github.run_number }}'/' android/app/build.gradle || \
            sed -i '/defaultConfig {/a\        versionCode '${{ github.run_number }}'' android/app/build.gradle || true
            
            # Update version name
            sed -i 's/versionName ".*"/versionName "'${{ github.ref_name || '1.0.0' }}'"/' android/app/build.gradle || \
            sed -i '/versionCode/a\        versionName "'${{ github.ref_name || '1.0.0' }}'"' android/app/build.gradle || true
            
            echo "‚úÖ Build config updated"
          else
            echo "‚ö†Ô∏è build.gradle not found"
            exit 1
          fi

      - name: Fix Kotlin dependency conflicts
        working-directory: client
        run: |
          if [ -f "android/app/build.gradle" ]; then
            echo "Fixing Kotlin dependency conflicts..."
            if ! grep -q "configurations.all" android/app/build.gradle; then
              # Use sed to insert configurations block before dependencies
              sed -i '/^dependencies {/i\
configurations.all {\
    exclude group: '\''org.jetbrains.kotlin'\'', module: '\''kotlin-stdlib-jdk7'\''\
    exclude group: '\''org.jetbrains.kotlin'\'', module: '\''kotlin-stdlib-jdk8'\''\
}\
' android/app/build.gradle || sed -i '$a\
configurations.all {\
    exclude group: '\''org.jetbrains.kotlin'\'', module: '\''kotlin-stdlib-jdk7'\''\
    exclude group: '\''org.jetbrains.kotlin'\'', module: '\''kotlin-stdlib-jdk8'\''\
}\
' android/app/build.gradle
              echo "Added Kotlin dependency exclusions"
            else
              echo "Kotlin dependency exclusions already exist"
            fi
            echo "‚úÖ Kotlin dependency conflicts fixed"
          else
            echo "‚ö†Ô∏è build.gradle not found"
            exit 1
          fi

      - name: Verify Android setup
        working-directory: client
        run: |
          echo "Verifying Android setup..."
          if [ ! -d "android" ]; then
            echo "‚ùå android directory not found"
            exit 1
          fi
          
          if [ ! -f "android/gradlew" ]; then
            echo "‚ùå gradlew not found"
            ls -la android/
            exit 1
          fi
          
          echo "‚úÖ Android setup verified"
          ls -la android/ | head -10

      - name: Build APK with Gradle
        working-directory: client/android
        run: |
          echo "Building APK..."
          chmod +x gradlew
          
          # Accept licenses
          yes | sdkmanager --licenses || true
          
          # Build release APK
          ./gradlew assembleRelease || {
            echo "Release build failed, trying debug build..."
            ./gradlew assembleDebug
          }
          
          echo "‚úÖ Gradle build completed"

      - name: Find APK file
        id: find_apk
        working-directory: client
        run: |
          echo "Searching for APK files..."
          
          # Search in standard locations
          APK_PATH=""
          
          if [ -d "android/app/build/outputs/apk/release" ]; then
            APK_PATH=$(find android/app/build/outputs/apk/release -name "*.apk" -type f 2>/dev/null | head -n 1)
            echo "Checked release directory"
          fi
          
          if [ -z "$APK_PATH" ] && [ -d "android/app/build/outputs/apk/debug" ]; then
            APK_PATH=$(find android/app/build/outputs/apk/debug -name "*.apk" -type f 2>/dev/null | head -n 1)
            echo "Checked debug directory"
          fi
          
          if [ -z "$APK_PATH" ]; then
            APK_PATH=$(find android -name "*.apk" -type f 2>/dev/null | head -n 1)
            echo "Searched entire android directory"
          fi
          
          if [ -n "$APK_PATH" ]; then
            echo "‚úÖ APK found at: $APK_PATH"
            echo "Size: $(du -h "$APK_PATH" | cut -f1)"
            echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT
            echo "apk_found=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå APK not found"
            echo "Listing build outputs:"
            find android/app/build/outputs -type f 2>/dev/null | head -20 || echo "No outputs directory"
            echo "apk_found=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload APK artifact
        if: steps.find_apk.outputs.apk_found == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: adlc-emergency-apk
          path: ${{ steps.find_apk.outputs.apk_path }}
          retention-days: 90

      - name: Build failure notification
        if: steps.find_apk.outputs.apk_found != 'true'
        run: |
          echo "::warning::APK build completed but APK file not found"
          echo ""
          echo "Debugging information:"
          echo "- Check if Gradle build completed successfully above"
          echo "- Verify Android SDK is properly set up"
          echo "- Check for Gradle errors in the build output"
          echo ""
          echo "This failure does NOT affect Render deployment."
          echo "The web app will still deploy successfully to Render."

  # Render deployment notification (Render deploys automatically via webhook)
  deploy-info:
    runs-on: ubuntu-latest
    needs: build-apk
    if: always()
    steps:
      - name: Deployment Status
        run: |
          if [ "${{ needs.build-apk.result }}" == "success" ] && [ "${{ needs.build-apk.outputs.apk_found }}" == "true" ]; then
            echo "‚úÖ APK build successful!"
            echo "üì± APK is available in the workflow artifacts."
          else
            echo "‚ö†Ô∏è APK build had issues (see build-apk job)."
          fi
          echo ""
          echo "üåê Render deployment happens automatically on push via webhook."
          echo "   Check your Render dashboard for deployment status."
